<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
    <h1>Blocking script on Main thread versus Worker thread</h1>
    <p>Click <b>Start Counter</b> button. Run blocking code on the main thread and in a worker thread by clicking the respective buttons.</p>
    <h2>Expected Behaviors</h2>
    <p>Blocking code run on the main thread blocks the counter. It pauses, then recommences when the blocking script is over. Blocking code run on the worker thread does not block the counter, it runs at the same pace continuously.</p>
    <p>Observed behavior: Main thread blocks as expected. The worker thread causes a "slow-down." The counter continues to count, but at a much slower pace.</p>
    <p>Note: the source of the issue is the console.log in the blocking while loop. But, the bug only appears if the console is closed.</p> 
    <div>
        <button id="start-counter" onclick="startCounter()">Start Counter</button>
        <button id="reset-counter" onclick="resetCounter()">Reset Counter</button>
        <p>Counter: <span id="counter">0</span></p>
    </div>
    <div>
        <button id="main-thread" onclick="startBlockingAction()">Run blocker on Main thread</button>
        <button id="worker-thread" onclick="startNonBlockingAction()">Run blocker on Worker thread</button>
        <p>Script message: <span id="script-message">Waiting for message</span></p>
    </div>
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />


    <script src="./blocker.js"></script>
    <script>

        function startNonBlockingAction() {
            const worker = new Worker("./worker.js")
            worker.postMessage('start');
            worker.onmessage = (e) => {
                document.querySelector("#script-message").textContent = e.data;
                worker.terminate();
            }
        }

        function startBlockingAction() {
            const message = blocker("Finished from main thread.");
            document.querySelector("#script-message").textContent = message
        }

        let stopper = false

        function resetCounter() {
            stopper = true
            document.querySelector("#counter").textContent = 0;
            document.querySelector("#script-message").textContent = "Waiting for message"
        }

        function startCounter() {
            if (stopper) {
                stopper = false;
                return;
            }
            const counter = document.querySelector("#counter");
            const number = parseInt(counter.textContent)
            counter.textContent = number + 1;
            window.requestAnimationFrame(startCounter)
        }
    </script>
</body>

</html>